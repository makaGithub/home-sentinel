Титульный лист
---

# Аннотация

В работе представлена система home-sentinel — интеллектуальная система мониторинга и распознавания для умного дома. Система обеспечивает распознавание членов семьи по лицу в реальном времени, детекцию объектов в видеопотоке, анализ аудио для обнаружения звуков и ведение статистики активности. Разработана архитектура с разделением нагрузки между двумя компьютерами: сервером для хранения данных и AI-сервером для вычислений на GPU. Реализована интеграция с существующими системами умного дома (Home Assistant, Immich). Система использует современные технологии машинного обучения (YOLOv11, InsightFace) и эффективно использует GPU для ускорения вычислений.

---

<!-- TOC -->

---

# Введение

Актуальность работы. В современном мире системы умного дома становятся все более популярными и востребованными. Одной из ключевых задач таких систем является распознавание людей и объектов в реальном времени для автоматизации различных процессов. Существующие решения часто требуют отдельной настройки и не интегрируются с уже имеющейся инфраструктурой.

Проблема исследования заключается в необходимости создания интеллектуальной системы, которая объединяет возможности распознавания лиц, детекции объектов и анализа аудио для создания полноценной системы мониторинга умного дома, при этом эффективно используя существующую инфраструктуру.

Объект исследования — системы мониторинга и распознавания для умного дома. Предмет исследования — методы и алгоритмы распознавания лиц и объектов в реальном времени с использованием технологий машинного обучения.

Цель работы — разработка системы home-sentinel для интеллектуального мониторинга и распознавания в умном доме с интеграцией в существующую инфраструктуру.

Задачи исследования:

- Изучить существующие решения для распознавания лиц и объектов в умном доме
- Разработать архитектуру системы с разделением нагрузки между сервером и AI-сервером
- Реализовать интеграцию с Home Assistant и Immich
- Реализовать алгоритмы распознавания лиц с использованием InsightFace
- Реализовать детекцию объектов с использованием YOLOv11
- Обеспечить эффективное использование GPU для ускорения вычислений
- Реализовать систему статистики и мониторинга

Методы работы: анализ научной литературы, проектирование архитектуры системы, программирование на Python с использованием библиотек машинного обучения, тестирование и оптимизация производительности.

---

# 1. Архитектура системы

Система home-sentinel построена на архитектуре с разделением нагрузки между двумя компьютерами, каждый из которых выполняет определенные задачи.

## 1.1. Первый компьютер (Сервер)

Первый компьютер выполняет функции сервера для хранения данных и управления умным домом. На нем установлены следующие компоненты:

- **USB-камера**: Обеспечивает видео и аудио поток для анализа
- **go2rtc**: Медиа-сервер для трансляции видео и аудио в RTSP. Доступ по сети: rtsp://server:8554/stream
- **Home Assistant**: Центральная система управления умным домом. Интеграция с датчиками, выключателями, устройствами. Автоматизация и сценарии
- **Immich**: Фото и видео менеджер для семьи. 2 Терабайта данных, ~150,000 фотографий и видео, ~100 распознанных лиц с именами в формате "Имя Фамилия". Распознавание лиц и создание альбомов. Веб-интерфейс для просмотра
- **PostgreSQL**: База данных для Immich. Хранение метаданных, векторных представлений лиц. Информация о людях и распознанных лицах
- **Жесткие диски**: Хранение медиафайлов Immich. Резервное копирование

## 1.2. Второй компьютер (AI-сервер)

Второй компьютер оснащен игровой видеокартой NVIDIA GPU и предназначен для выполнения AI вычислений. На нем запущен сервис home-sentinel, который включает:

- **NVIDIA GPU**: Игровая видеокарта. Ускорение AI вычислений. CUDA поддержка
- **home-sentinel**: YOLOv11 - детекция объектов. InsightFace - распознавание лиц. Анализ аудио потоков. Статистика и логирование

Подключения AI-сервера:

- RTSP поток с первого ПК (go2rtc)
- PostgreSQL (Immich БД)
- Home Assistant API
- Immich API (опционально)

---

# 2. Компоненты системы

## 2.1. Home Assistant

Home Assistant — это открытая платформа для автоматизации умного дома. Основные функции: централизованное управление всеми устройствами умного дома, создание автоматизаций и сценариев, интеграция с тысячами устройств и сервисов, веб-интерфейс и мобильные приложения, поддержка MQTT, REST API, WebSocket.

В нашей системе home-sentinel отправляет события в Home Assistant, что позволяет запускать автоматизации на основе распознавания людей. Например, можно включить свет при распознавании конкретного человека.

## 2.2. go2rtc

go2rtc — это легковесный медиа-сервер для трансляции видео и аудио. Функции: преобразование различных источников в RTSP поток, поддержка USB-камер, IP-камер, файлов, низкая задержка трансляции, поддержка аудио и видео одновременно.

## 2.3. Immich

Immich — это современный фото и видео менеджер с функциями AI. Основные возможности: автоматическая загрузка и организация фотографий, распознавание лиц с помощью AI (InsightFace), создание альбомов по людям, поиск по лицам, объектам, местам, веб-интерфейс для просмотра, мобильные приложения для iOS и Android, резервное копирование и синхронизация.

Наша конфигурация: объем данных — 2 Терабайта, количество медиафайлов — ~150,000 фотографий и видео, период — вся история семьи, распознанные лица — ~100 человек с именами в формате "Имя Фамилия", база данных — PostgreSQL с векторными представлениями лиц.

Интеграция с home-sentinel: home-sentinel использует векторные представления лиц из Immich, имена людей (в формате "Имя Фамилия") также подгружаются из Immich, не нужно создавать отдельную базу данных лиц, используется уже распознанная и размеченная информация, синхронизация происходит автоматически.

## 2.4. PostgreSQL

PostgreSQL — это мощная реляционная база данных с открытым исходным кодом. В нашей системе хранит все данные Immich (метаданные, пути к файлам), содержит таблицы с информацией о людях, хранит векторные представления лиц (512-мерные векторы), таблица asset_face связывает лица с фотографиями, таблица face_search содержит векторные представления для быстрого поиска.

## 2.5. home-sentinel

home-sentinel — это AI-сервис для анализа видеопотоков и аудиопотоков. Компоненты системы:

**YOLOv11 (You Only Look Once)**: детекция объектов в реальном времени, обнаружение людей, животных, предметов, высокая скорость обработки благодаря GPU, модель yolo11n.pt (nano версия для баланса скорости/точности).

**InsightFace**: распознавание и сравнение лиц, использует модель antelopev2 (совместима с Immich), извлечение 512-мерных векторных представлений, сравнение с базой лиц из Immich.

**Аудио анализ**: детекция звуков (речь, стук в дверь, лай собаки), поддержка RTSP аудио потоков, статистика обнаруженных звуков.

**Статистика**: запись фактов появления людей, запись обнаруженных звуков, отдельная БД для статистики, возможность анализа активности.

---

# 3. Технологический стек

## 3.1. Backend

- Python 3.10
- PyTorch (GPU ускорение)
- OpenCV (обработка видео)
- NumPy (математические операции)

## 3.2. AI/ML

- YOLOv11 (ultralytics) - детекция объектов
- InsightFace - распознавание лиц
- CUDA - GPU вычисления

## 3.3. Инфраструктура

- Docker & Docker Compose
- PostgreSQL
- RTSP протокол

## 3.4. Интеграции

- Home Assistant API
- Immich API
- PostgreSQL (psycopg2)

---

# 4. Поток данных

1. USB-камера → go2rtc → RTSP поток (видео и аудио в реальном времени)
2. home-sentinel подключается к RTSP потоку и получает кадры видео и аудио
3. YOLOv11 анализирует каждый кадр и обнаруживает объекты (person, dog, tv, bed и т.д.)
4. Для каждого обнаруженного "person": InsightFace извлекает векторное представление лица, сравнивает с базой из Immich, определяет имя человека (если сходство > порога)
5. Результаты отправляются в Home Assistant (события распознавания), в БД статистики (запись факта появления), в логи (для отладки и мониторинга)
6. Аудио анализ: детекция звуков в реальном времени, запись в статистику при обнаружении

---

# 5. Реализация

## 5.1. Структура проекта

Проект организован следующим образом:

- code/ - код сервиса (main.py, models.py, embeddings.py, camera.py, audio_detector.py, database.py, stats.py)
- data/ - данные (cache/ для кэшей векторных представлений, models/ для моделей ML)
- docker-compose.yml - конфигурация Docker Compose
- deploy.sh - скрипт деплоя
- setup-host.sh - настройка хоста

## 5.2. Ключевые алгоритмы

### Распознавание лиц

Алгоритм распознавания лиц использует следующие этапы: детекция лица с помощью InsightFace, извлечение 512-мерного векторного представления, нормализация вектора (L2 нормализация), сравнение с базой векторных представлений из Immich, вычисление косинусного сходства, применение адаптивного порога в зависимости от размера лица, проверка минимальной разницы между лучшим и вторым результатом.

### Анти-дребезг

Для стабилизации детекции объектов используется алгоритм анти-дребезга: отслеживание объектов в течение нескольких кадров, минимальное количество стабильных кадров для регистрации объекта (MIN_STABLE), максимальное количество пропущенных кадров перед удалением (MAX_MISSING), постепенное уменьшение стабильности при пропуске кадров.

---

# 6. Результаты

В результате реализации проекта была создана система home-sentinel, которая:

- Успешно распознает членов семьи по лицу в реальном времени
- Детектирует объекты в видеопотоке с высокой точностью
- Анализирует аудио потоки для обнаружения звуков
- Ведет статистику активности и интегрируется с Home Assistant
- Использует существующую инфраструктуру (Immich, Home Assistant)
- Эффективно использует GPU для ускорения вычислений

## 6.1. Преимущества архитектуры

- Разделение нагрузки: первый ПК для хранения данных, второй для AI вычислений
- Масштабируемость: возможность добавления больше AI-серверов и камер
- Эффективность: GPU используется только для AI задач
- Надежность: компоненты изолированы, при сбое одного остальные работают
- Использование существующей инфраструктуры: не нужно дублировать данные

---

# Выводы

- Разработана архитектура системы home-sentinel с разделением нагрузки между сервером и AI-сервером
- Реализована интеграция с существующими системами умного дома (Home Assistant, Immich)
- Реализованы алгоритмы распознавания лиц с использованием InsightFace и детекции объектов с использованием YOLOv11
- Обеспечено эффективное использование GPU для ускорения вычислений
- Реализована система статистики и мониторинга активности
- Система успешно распознает членов семьи по лицу в реальном времени и детектирует объекты с высокой точностью

---

# Заключение

home-sentinel — это интеллектуальная система, которая использует существующую инфраструктуру (Immich, Home Assistant), эффективно использует ресурсы (GPU на отдельном ПК), обеспечивает распознавание в реальном времени, ведет статистику и интегрируется с умным домом. Система легко развертывается и масштабируется.

Система готова к использованию и может быть расширена дополнительными функциями, такими как голосовое управление, синтез речи (TTS), интеграция с другими системами умного дома и т.д.

---

# Список литературы

1. Redmon, J., & Farhadi, A. (2018). YOLOv3: An Incremental Improvement. arXiv preprint arXiv:1804.02767.
2. Wang, C. Y., Bochkovskiy, A., & Liao, H. Y. M. (2023). YOLOv7: Trainable bag-of-freebies sets new state-of-the-art for real-time object detectors. Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition.
3. Deng, J., Guo, J., Ververas, E., Kotsia, I., & Zafeiriou, S. (2020). RetinaFace: Single-Shot Multi-Level Face Localisation in the Wild. Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition.
4. Guo, J., Deng, J., Lattas, A., & Zafeiriou, S. (2021). Sample and Computation Redistribution for Efficient Face Detection. arXiv preprint arXiv:2105.04714.
5. Bradski, G. (2000). The OpenCV Library. Dr. Dobb's Journal of Software Tools.
6. Paszke, A., et al. (2019). PyTorch: An Imperative Style, High-Performance Deep Learning Library. Advances in Neural Information Processing Systems.
7. Home Assistant. (2024). Home Assistant Documentation. https://www.home-assistant.io/docs/
8. Immich. (2024). Immich Documentation. https://immich.app/docs/
9. PostgreSQL Global Development Group. (2024). PostgreSQL Documentation. https://www.postgresql.org/docs/
10. Docker Inc. (2024). Docker Documentation. https://docs.docker.com/
11. NVIDIA Corporation. (2024). CUDA Toolkit Documentation. https://docs.nvidia.com/cuda/
12. OpenAI. (2023). Whisper: Robust Speech Recognition via Large-Scale Weak Supervision. arXiv preprint arXiv:2212.04356.

---

# Приложения

Приложение А. Структура проекта home-sentinel

Приложение Б. Пример конфигурационного файла .env

Приложение В. Схема архитектуры системы

