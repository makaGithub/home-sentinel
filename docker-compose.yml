services:
  home-sentinel:
    build:
      context: ./code
      dockerfile: Dockerfile
      cache_from:
        - type=local,src=data/.buildx-cache
      cache_to:
        - type=local,dest=data/.buildx-cache,mode=max
    container_name: home-sentinel
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      # Отключаем CUDA баннер при старте контейнера
      - NVIDIA_DISABLE_REQUIRE=1
    volumes:
      # Монтируем код в /app/code (чтобы избежать конфликтов с cache и models)
      - ./code:/app/code
      # Монтируем директории данных (они должны существовать на хосте ДО запуска)
      - ./data/cache:/app/cache
      - ./data/models:/app/models
      - ./data/screenshots:/app/data/screenshots
    working_dir: /app/code
    command: ["python3.10", "main.py"]
    networks:
      - home-sentinel-net

  screenshots-web:
    image: nginx:alpine
    container_name: screenshots-web
    restart: unless-stopped
    ports:
      - "${SCREENSHOTS_WEB_PORT:-8080}:80"
    volumes:
      - ./data/screenshots:/screenshots:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/index.html:/usr/share/nginx/html/index.html:ro
    networks:
      - home-sentinel-net

  # NFS сервер для доступа к скриншотам из Home Assistant
  screenshots-nfs:
    image: itsthenetwork/nfs-server-alpine:latest
    container_name: screenshots-nfs
    restart: unless-stopped
    privileged: true
    environment:
      - SHARED_DIRECTORY=/screenshots
    volumes:
      - ./data/screenshots:/screenshots:rw
    ports:
      - "${NFS_PORT:-2049}:2049"
    networks:
      - home-sentinel-net

networks:
  home-sentinel-net:
    driver: bridge
